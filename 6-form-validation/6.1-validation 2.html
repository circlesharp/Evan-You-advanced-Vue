<script src="../node_modules/vue/dist/vue.js"></script>

<div id="app">
  <form @submit="validate">
    <input v-model="text">
    <br>
    <input v-model="email">

    <ul v-if="!$v.valid" style="color:red">
      <li v-for="error in $v.errors">
        {{ error }}
      </li>
    </ul>

    <input type="submit" :disabled="!$v.valid">
  </form>
</div>

<script>
  // 基本上成了，好奇 mixin 的生命周期
  const validPlugin = {
    install (Vue) {
      Vue.mixin({
        computed: {
          $v () {
            let valid = true
            let errors = []
            let validations = this.$options.validations

            if (!validations) { return { valid,  errors } }

            Object.keys(validations).forEach(key =>{
              let validate = validations[key].validate
              let message = validations[key].message
              let value = this[key]
              if (!validate(value)) {
                valid = false
                errors.push(message(key, value))
              }
            })

            return { valid, errors }
          }
        }
      })
    }
  }

  Vue.use(validPlugin)

  const emailRE = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/

  new Vue({
    el: '#app',
    data: {
      text: 'foo',
      email: ''
    },
    validations: {
      text: {
        validate: value => value.length >= 5,
        message: (key, value) => `${key} should have a min length of 5, but got ${value.length}`
      },
      email: {
        validate: value => emailRE.test(value),
        message: key => `${key} must be a valid email`
      }
    },
    methods: {
      validate (e) {
        if (!this.$v.valid) {
          e.preventDefault()
          alert('not valid!')
        }
      }
    }
  })
</script>
